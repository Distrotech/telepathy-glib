#!/bin/sh

mk_specdir="lib/spec"
mk_toolsdir="lib/tools"

XSLTPROC=@XSLTPROC@
top_srcdir=@abs_top_srcdir@

toolsdir="${top_srcdir}/${mk_toolsdir}"
specdir="${top_srcdir}/${mk_specdir}"

outfile="$1"
gendir="$2"
whitelist="$3"

SPEC_INTERFACES="`$XSLTPROC --nonet --novalid --xinclude $toolsdir/ls-interfaces.xsl $specdir/all.xml`"

install -d ./`dirname "$outfile"`
exec > "$outfile.tmp"

printf "$outfile: \$(top_srcdir)/$mk_specdir/all.xml \\\\\\n"
printf "\\t\\t\$(top_srcdir)/$mk_specdir/all.xml \\\\\\n"
printf "\\t\\t\$(SPEC_INTERFACE_XMLS) \\\\\\n"
printf "\\t\\t\$(top_srcdir)/$mk_toolsdir/ls-interfaces.xsl \\\\\\n"
printf "\\t\\t\$(top_builddir)/$mk_toolsdir/update-spec-gen-am.sh\\n"
printf "\\t\$(SHELL) \$(top_builddir)/$mk_toolsdir/update-spec-gen-am.sh $outfile $gendir $whitelist\\n"

for class in INTERFACES INTERFACE_XMLS GENERATED_CS GENERATED_HS \
             GENERATED_LISTS GLUE_HS
do
  echo "STABLE_SPEC_$class ="
  echo "UNSTABLE_SPEC_$class ="
done

for iface in $SPEC_INTERFACES
do
  if test -z "$whitelist" || grep "^$iface\$" "$whitelist" >/dev/null
  then
    stability=STABLE
  else
    stability=UNSTABLE
  fi
  echo "${stability}_SPEC_INTERFACES += $iface"
  echo "${stability}_SPEC_INTERFACE_XMLS += \$(top_srcdir)/$mk_specdir/$iface.xml"
  echo "${stability}_SPEC_GENERATED_CS += $gendir/svc-$iface.c"
  echo "${stability}_SPEC_GENERATED_HS += $gendir/svc-$iface.h"
  echo "${stability}_SPEC_GLUE_HS += $gendir/svc-$iface-glue.h"
  echo "${stability}_SPEC_GENERATED_LISTS +="\
       "$gendir/svc-$iface-signals-marshal.list"
done

for class in INTERFACES INTERFACE_XMLS GENERATED_CS GENERATED_HS \
             GENERATED_LISTS GLUE_HS
do
  echo "SPEC_$class = \$(STABLE_SPEC_$class) \$(UNSTABLE_SPEC_$class)"
done

mv "$outfile.tmp" "$outfile"
